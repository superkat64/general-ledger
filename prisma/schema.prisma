generator client {
  provider = "prisma-client-js"
}

// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public"]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model category {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String           @db.Uuid
  name           String
  monthly_budget Decimal?         @db.Decimal(12, 2)
  type           transaction_type @default(expense)
  color          String?
  icon           String?
  created_at     DateTime         @default(now()) @db.Timestamptz(6)
  updated_at     DateTime         @default(now()) @db.Timestamptz(6)
  subcategory    subcategory[]

  @@unique([user_id, name], map: "uq_category_user_name")
  @@index([user_id], map: "idx_category_user")
  @@schema("public")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model institution {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id          String        @db.Uuid
  name             String
  type             String?
  color            String?
  last_four_digits String?
  created_at       DateTime      @default(now()) @db.Timestamptz(6)
  updated_at       DateTime      @default(now()) @db.Timestamptz(6)
  transaction      transaction[]

  @@unique([user_id, name, last_four_digits], map: "uq_institution_user_name_4")
  @@index([user_id], map: "idx_institution_user")
  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model subcategory {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  category_id String        @db.Uuid
  name        String
  created_at  DateTime      @default(now()) @db.Timestamptz(6)
  updated_at  DateTime      @default(now()) @db.Timestamptz(6)
  category    category      @relation(fields: [category_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  transaction transaction[]

  @@unique([category_id, name], map: "uq_subcategory_cat_name")
  @@index([category_id], map: "idx_subcategory_category")
  @@schema("public")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model has constraints using non-default deferring rules and requires additional setup for migrations. Visit https://pris.ly/d/constraint-deferring for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model transaction {
  id               String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id          String           @db.Uuid
  transaction_date DateTime         @db.Date
  amount           Decimal          @db.Decimal(12, 2)
  transaction_type transaction_type @default(expense)
  description      String?
  subcategory_id   String?          @db.Uuid
  institution_id   String?          @db.Uuid
  payment_method   String?
  is_recurring     Boolean          @default(false)
  note             String?
  created_at       DateTime         @default(now()) @db.Timestamptz(6)
  updated_at       DateTime         @default(now()) @db.Timestamptz(6)
  institution      institution?     @relation(fields: [institution_id], references: [id], onUpdate: NoAction)
  subcategory      subcategory?     @relation(fields: [subcategory_id], references: [id], onUpdate: NoAction)

  @@index([user_id, transaction_date(sort: Desc)], map: "idx_tx_user_date")
  @@index([user_id, subcategory_id], map: "idx_tx_user_subcat")
  @@index([user_id, transaction_type], map: "idx_tx_user_type")
  @@schema("public")
}

enum transaction_type {
  expense
  income
  transfer

  @@schema("public")
}
